<?php
	
	session_start();
	
	$ruta = "../";
    
	while (!is_file($ruta.'Connections/sala2.php'))
	{
		$ruta = $ruta."../";
		echo "<br/><br/>".$ruta;
	}
   
    include($ruta.'Connections/sala2.php');
    
    $rutaado = $ruta."funciones/adodb/";
    var_dump($hostname_sala); echo "<br/><br/>";
    include($ruta.'Connections/salaado.php');
	require_once(realpath(dirname(__FILE__)).'/../../consulta/interfacespeople/conexionpeople.php');
	require_once(realpath(dirname(__FILE__)).'/../../../nusoap/lib/nusoap.php');
	require_once(realpath(dirname(__FILE__)).'/../../consulta/interfacespeople/reporteCaidaPeople.php');
	require_once(realpath(dirname(__FILE__)).'/../../consulta/interfacespeople/funcionesPS.php');
	
	function ModiEstudiante($db,$xml,$id){
		$client = new nusoap_client(WEBREPORTAPAGOPSE, true, false, false, false, false, 0, 30);
		$result = $client->call('UBI_PAGO_PSE_OPR_SRV',$xml);
		$parametro = 'id:'.$result['ERRNUM'].' descripcion:'.$result['DESCRLONG'];
		echo "<p>Reporte de registro enviado: ID ".$id." Resultado de operacion: ".$result['ERRNUM']." Descripcion: ".$result['DESCRLONG']."</p>";
		return $parametro;
	}
	
	function ModificaSQL($db,$parametro,$id){
    
        $SQL="UPDATE logtraceintegracionps 
              SET    respuestalogtraceintegracionps='".$parametro."',
                     estadoenvio=1,
                     fecharegistrologtraceintegracionps=NOW()
              WHERE  idlogtraceintegracionps=".$id;
              
		if($Modifica=$db->Execute($SQL)==false){
			Echo '<br />Error en el Modificar Log....<br><br>'.$SQL.' El error es: '.mysql_error();
			//die;
		}
	}//function ModificaSQL
	
	//if($_REQUEST['envio']){
		
		echo "<h2>Iniciando envio de PAGOS pse en 3...2...1...</h2>";
		
		$SQL = "SELECT
	idlogtraceintegracionps,
	enviologtraceintegracionps
FROM
	`logtraceintegracionps`
WHERE
	transaccionlogtraceintegracionps LIKE '%PSE%'
AND estadoenvio = 2
AND documentologtraceintegracionps IN (
	2180312,
	2182264,
	2182263,
	2180229,
	2182391,
	2182367,
	2182073,
	2182341,
	2170555,
	2180639,
	2181464,
	2169261,
	2158516,
	2182454,
	2182496,
	2182634,
	2182645,
	2182290,
	2182150,
	2182707,
	2182612,
	2182586,
	2182605,
	2182813,
	2174822,
	2182574,
	2182644,
	2182299,
	2178293,
	2182881,
	2155302,
	2182120,
	2160512,
	2168351,
	2182913,
	2182673,
	2182301,
	2182297,
	2182300,
	2182934,
	2182109,
	2182944,
	2182727,
	2181354,
	2182954,
	2181521,
	2182994,
	2146012,
	2182265,
	2182232,
	2165818,
	2182234,
	2142747,
	2182013,
	2152353,
	2182922,
	2183016,
	2182249,
	2174475,
	2114309,
	2180265,
	2172465,
	2183301,
	2180530,
	2183308,
	2183315,
	2181139,
	2183366,
	2183273,
	2183388,
	2183432,
	2183445,
	2183448,
	2183462,
	2182016,
	2182782,
	2175613,
	2180545,
	2180246,
	2183593,
	2182717,
	2183640,
	2183453,
	2183514,
	2183691,
	2183693,
	2183694,
	2183061,
	2183198,
	2183590,
	2183705,
	2183697,
	2183209,
	2183469,
	2183715,
	2183718,
	2138991,
	2183721,
	2183720,
	2182385,
	2183729,
	2183730,
	2183497,
	2183736,
	2125733,
	2183737,
	2183741,
	2183240,
	2183747,
	2181179,
	2183733,
	2183763,
	2183702,
	2183815,
	2183818,
	2183838,
	2134162,
	2182611,
	2183876,
	2183912,
	2183664,
	2183976,
	2181481,
	2161576,
	2178509,
	2177215,
	2184004,
	2183680,
	2182967,
	2184006,
	2183671,
	2172907,
	2184022,
	2184027,
	2184028,
	2183748,
	2184039,
	2183703,
	2184047,
	2183530,
	2184065,
	2183728,
	2184165,
	2183164,
	2181720,
	2184208,
	2184209,
	2183553,
	2184220,
	2184235,
	2174733,
	2181910,
	2182182,
	2184210,
	2184317,
	2176147,
	2117591,
	2184412,
	2184392,
	2184418,
	2184416,
	2183819,
	2184010,
	2184031,
	2184497,
	2129866,
	2184514,
	2184260,
	2184608,
	2184449,
	2184012,
	2181983,
	2184664,
	2181483,
	2184533,
	2126371,
	2184690,
	2182036,
	2184722,
	2184724,
	2184214,
	2181523,
	2184739,
	2180255,
	2184528,
	2183752,
	2184289,
	2184755,
	2184974,
	2180293,
	2184985,
	2184995,
	2184996,
	2184774,
	2185008,
	2185021,
	2185034,
	2185037,
	2185038,
	2185020,
	2183884,
	2185047,
	2182524,
	2185058,
	2185061,
	2185063,
	2185069,
	2181159,
	2151875,
	2185075,
	2185036,
	2146047,
	2147372,
	2185181,
	2181192,
	2185103,
	2185026,
	2184744,
	2177731,
	2143422,
	2113592,
	2126915,
	2185307,
	2185309,
	2185314,
	2184040,
	2184394,
	2181185,
	2185322,
	2185351,
	2185409,
	2184230,
	2160642,
	2185317,
	2180081,
	2185503,
	2185308,
	2119434,
	2185517,
	2185552,
	2166856,
	2184707,
	2185275,
	2185613,
	2185636,
	2137976,
	2185655,
	2180470,
	2185667,
	2176295,
	2184527,
	2184532,
	2185734,
	2185016,
	2184986,
	2181512,
	2183527,
	2185786,
	2120443,
	2185412,
	2185477,
	2181114,
	2185834,
	2185844,
	2174282,
	2185611,
	2185860,
	2185885,
	2185897,
	2185899,
	2185900,
	2185905,
	2185906,
	2185913,
	2179612,
	2185741,
	2185909,
	2185932,
	2115642,
	2171142,
	2182925,
	2181679,
	2185990,
	2184748,
	2186006,
	2185729,
	2185838,
	2186040,
	2179614,
	2186101,
	2186104,
	2186105,
	2181398,
	2186112,
	2185238,
	2185420,
	2185903,
	2180263,
	2186135,
	2186136,
	2179947,
	2182206,
	2186141,
	2186149,
	2186166,
	2181442,
	2186190,
	2181231,
	2156671,
	2175785,
	2186220,
	2186250,
	2186283,
	2185491,
	2186327,
	2185520,
	2186336,
	2186355,
	2186115,
	2186394,
	2185334,
	2184908,
	2181177,
	2186471,
	2186052,
	2186497,
	2186527,
	2186531,
	2186532,
	2152787,
	2186578,
	2186595,
	2186599,
	2178421,
	2178342,
	2186665,
	2175285,
	2186685,
	2186690,
	2185874,
	2185963,
	2186696,
	2186590,
	2178244,
	2186212,
	2186739,
	2186750,
	2186244,
	2186804,
	2186891,
	2186902,
	2186609,
	2186909,
	2186682,
	2186921,
	2186912,
	2186948,
	2143857,
	2186960,
	2187008,
	2186624,
	2125159,
	2119723,
	2184015,
	2187054,
	2187056,
	2186492,
	2187061,
	2187067,
	2118985,
	2187069,
	2187076,
	2186597,
	2187089,
	2186164,
	2186217,
	2178135,
	2187146,
	2187150,
	2186313,
	2180200,
	2177297,
	2187205,
	2180523,
	2187217,
	2187226,
	2146497,
	2187240,
	2187107,
	2187239,
	2187247,
	2187265,
	2187314,
	2181295,
	2187198,
	2187320,
	2186530,
	2186697,
	2187340,
	2113215,
	2187110,
	2182233,
	2187366,
	2187375,
	2186350,
	2187395,
	2183722,
	2186634,
	2187368,
	2187469,
	2187484,
	2187393,
	2187493,
	2175603,
	2187528,
	2187535,
	2187540,
	2187542,
	2187551,
	2187579,
	2187516,
	2187593,
	2186623,
	2187415,
	2187628,
	2187637,
	2187650,
	2187463,
	2187693,
	2187026,
	2187720,
	2187723,
	2187482,
	2187743,
	2118612,
	2186319,
	2187063,
	2187634,
	2167764,
	2187372,
	2187788,
	2187792,
	2187855,
	2187341,
	2187892,
	2172370,
	2187905,
	2187922,
	2187906,
	2187848,
	2187339,
	2187851,
	2187999,
	2187613,
	2188015,
	2125578,
	2163391,
	2163392,
	2187912,
	2188047,
	2186816,
	2188102,
	2188106,
	2187950,
	2188088,
	2187188,
	2187195,
	2187157,
	2187873,
	2188181,
	2188092,
	2188323,
	2188327,
	2188177,
	2188376,
	2158590,
	2187570,
	2188394,
	2188385,
	2188421,
	2188424,
	2188314,
	2188429,
	2188447,
	2188448,
	2177255,
	2177458,
	2188455,
	2188471,
	2166094,
	2180572,
	2188387,
	2167741,
	2181229,
	2187736,
	2188485,
	2188489,
	2188505,
	2188532,
	2187347,
	2187709,
	2186799,
	2188649,
	2188388,
	2188392,
	2188747,
	2188763,
	2188768,
	2188766,
	2188778,
	2188750,
	2188787,
	2188794,
	2188784,
	2188837,
	2181103,
	2187474,
	2188886,
	2188940,
	2174799,
	2184121,
	2187994,
	2189013,
	2189023,
	2169083,
	2141146,
	2188317,
	2189050,
	2186106,
	2188458,
	2189091,
	2189097,
	2187561,
	2189093,
	2189120,
	2189126,
	2189131,
	2189132,
	2189149,
	2179607,
	2189164,
	2187966,
	2189177,
	2189187,
	2187882,
	2189268,
	2187967,
	2189291,
	2189069,
	2127804,
	2185095,
	2189380,
	2127471,
	2188838,
	2189395,
	2189403,
	2189405,
	2189404,
	2189407,
	2174809,
	2189424,
	2189423,
	2189491,
	2188565,
	2189534,
	2187795,
	2189428,
	2189716,
	2189725,
	2189745,
	2189766,
	2188892,
	2189780,
	2189806,
	2189560,
	2151717,
	2189735,
	2189773,
	2189092,
	2188167,
	2190012,
	2179904,
	2190037,
	2190039,
	2190040,
	2190044,
	2190056,
	2190062,
	2188820,
	2190075,
	2190074,
	2185805,
	2190101,
	2189733,
	2162876,
	2190114,
	2190072,
	2180289,
	2164740,
	2190141,
	2190159,
	2190094,
	2190073,
	2188550,
	2190253,
	2187077,
	2190258,
	2190115,
	2174287,
	2190311,
	2190315,
	2181757,
	2190349,
	2190343,
	2190363,
	2190385,
	2182730,
	2190423,
	2190445,
	2190450,
	2190456,
	2190459,
	2190458,
	2188646,
	2190471,
	2189060,
	2189384,
	2190478,
	2190480,
	2166938,
	2151749,
	2190485,
	2190491,
	2190493,
	2184671,
	2190515,
	2125838,
	2190523,
	2190529,
	2189220,
	2190362,
	2189105,
	2190371,
	2190619,
	2190628,
	2181108,
	2190675,
	2190680
) GROUP BY documentologtraceintegracionps";
								
		if($Data=&$db->Execute($SQL)===false){
            echo 'Error en el SQL de Buscar Data...<br><br>'.$SQL.' El error es: '.mysql_error();
            die;
        }
		
		if($Data){
            while(!$Data->EOF){
				$parametro = ModiEstudiante($db, $Data->fields['enviologtraceintegracionps'], $Data->fields['idlogtraceintegracionps']);
				ModificaSQL($db, $parametro, $Data->fields['idlogtraceintegracionps']);
				$Data->MoveNext();
            }
        }
		echo "<p>Termino el envio...</p>";
	//}
	
?>